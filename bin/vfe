#!/usr/bin/env node
'use strict';

var commander = require('commander')
var path = require('path')
var mkdirp = require('mkdirp')
var request = require('request')
var unzip = require('unzip')
var ProgressBar = require('progress')
var ncp = require('ncp').ncp
var meta = require('../package.json')
var ENV = process.env
var tmp_dir = require('path').join(ENV.APPDATA || ENV.HOME || __dirname, '.vfe')

mkdirp.sync(tmp_dir)

commander
	.version(meta.version)

commander
	.command('init')
	.description('Init vfe component project with init-template.')
	.action(function (dir, action) {
		if (arguments.length <=1 ) {
			action = dir
			dir = null
		}
		var dest = dir || '.'
		mkdirp.sync(dest)
		console.log('Waiting...')
		request({
				url: 'https://github.com/switer/vfe-init-template/archive/master.zip',
				proxy: 'http://proxy.tencent.com:8080'
			})
			.on('response', function (res) {
				var len = parseInt(res.headers['content-length'], 10)
				if (len) {
					var bar = new ProgressBar('  downloading [:bar] :percent :etas', {
						complete: '=',
						incomplete: ' ',
						width: 20,
						total: len
					})
					console.log('')
					res.on('data', function (chunk) {
				 		bar.tick(chunk.length);
					})
				}
				res.on('end', function () {
					console.log('')
				})
			})
			.on('error', function (err) {
				console.error(err)
			})
			.pipe(unzip.Extract({ path: tmp_dir }))
			.on('close', function () {
				ncp.limit = 16
				ncp(path.join(tmp_dir, 'vfe-init-template-master'), dest, function (err) {
					if (err) {
					   return console.error(err)
					 }
				})
		  	})
	})

commander.parse(process.argv)